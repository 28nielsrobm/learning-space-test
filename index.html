<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Learning Space</title>
<link rel="icon" href="data:,">

<style>
/* ======================
   GLOBAL STYLES
   ====================== */
body {
  background:#111;
  margin:0;
  height:100vh;
  overflow:hidden;
  font-family:sans-serif;
  color:white;
}

/* ======================
   GAME AREA
   ====================== */
.game-area {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:600px;
  height:600px;
  background:#222;
  border:3px solid #000;
  z-index:9999;
}

.player { position:absolute; width:40px; height:40px; }
.coin { position:absolute; width:30px; height:30px; background:gold; border-radius:50%; }
.label { position:absolute; font-weight:bold; }

/* ======================
   MENU
   ====================== */
.menu {
  position:fixed;
  inset:0;
  background:#111;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:20000;
}

.menu-sliders { text-align:center; margin:12px 0; }
.menu button { padding:10px 20px; font-size:18px; cursor:pointer; }

/* ======================
   GAME OVER
   ====================== */
.game-over {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:30000;
  text-align:center;
}

.game-over button {
  margin-top:12px;
  padding:10px 24px;
  font-size:18px;
  cursor:pointer;
}

/* ======================
   LOADING OVERLAY (NEW)
   ====================== */
.loading {
  position:fixed;
  inset:0;
  background:#111;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:40000;
  font-size:24px;
}

/* ======================
   HIDDEN
   ====================== */
.hidden { display:none !important; }
</style>
</head>
<body>

<!-- ===== LOADING SCREEN (NEW) ===== -->
<div id="loadingScreen" class="loading">
  Loading saved dataâ€¦
</div>

<!-- ===== MENU ===== -->
<div id="menu" class="menu hidden">
  <h1>Learning Space</h1>

  <div>
    <label><input type="radio" name="mode" value="1" checked> Single Player</label>
    <label><input type="radio" name="mode" value="2"> Two Players</label>
  </div>

  <div class="menu-sliders">
    Player 1 Speed:
    <input type="range" id="menuSpeed1" min="1" max="10">
    <br><br>
    Player 2 Speed:
    <input type="range" id="menuSpeed2" min="1" max="10">
  </div>

  <button id="startButton">Start Game</button>
</div>

<button id="saveButton" class="hidden">Save Now</button>

<!-- ===== GAME OVER ===== -->
<div id="gameOverScreen" class="game-over hidden">
  <h1>Game Over</h1>
  <p id="finalScore1"></p>
  <p id="finalScore2"></p>
  <p id="finalHighScore1"></p>
  <p id="finalHighScore2"></p>

  <button id="gameOverReplay">Replay</button>
  <button id="backToMenu">Back to Menu</button> <!-- NEW -->
</div>

<script>
/* ======================
   CONSTANTS & STATE
   ====================== */
const GAME_SIZE=600, PLAYER_SIZE=40, COIN_SIZE=30;
let gameOver=false, timeLeft=60, timerInterval;
let gameMode=1;
let rafId = null;
let isPaused = false;

/* ======================
   ELEMENTS
   ====================== */
const loadingScreen=document.getElementById('loadingScreen');
const menu=document.getElementById('menu');
const startButton=document.getElementById('startButton');
const saveButton=document.getElementById('saveButton');
const menuSpeed1=document.getElementById('menuSpeed1');
const menuSpeed2=document.getElementById('menuSpeed2');
const modeButtons=document.getElementsByName('mode');

const gameOverScreen=document.getElementById('gameOverScreen');
const backToMenu=document.getElementById('backToMenu');
const gameOverReplay=document.getElementById('gameOverReplay');

const finalScore1=document.getElementById('finalScore1');
const finalScore2=document.getElementById('finalScore2');
const finalHighScore1=document.getElementById('finalHighScore1');
const finalHighScore2=document.getElementById('finalHighScore2');

/* ======================
   SCORES
   ====================== */
let score1=0, score2=0;
let highScore1=Number(localStorage.getItem('highScore1'))||0;
let highScore2=Number(localStorage.getItem('highScore2'))||0;
let step1=Number(localStorage.getItem('player1Speed'))??3;
let step2=Number(localStorage.getItem('player2Speed'))??3;

/* ======================
   GAME AREA
   ====================== */
const gameArea=document.createElement('div');
gameArea.className='game-area';
document.body.appendChild(gameArea);

function createPlayer(color,x,y){
  const p=document.createElement('div');
  p.className='player';
  p.style.backgroundColor=color;
  p.style.left=x+'px';
  p.style.top=y+'px';
  return p;
}

const player1=createPlayer('#ff4d4d',100,180);
const player2=createPlayer('#4d4dff',450,180);
gameArea.append(player1,player2);

/* ======================
   LABELS
   ====================== */
function makeLabel(text,top,left){
  const l=document.createElement('div');
  l.className='label';
  l.textContent=text;
  l.style.top=top;
  l.style.left=left;
  gameArea.appendChild(l);
  return l;
}

const scoreDisplay1=makeLabel('Score: 0','5px','5px');
const scoreDisplay2=makeLabel('Score: 0','5px','500px');
const highScoreDisplay1=makeLabel('High Score: '+highScore1,'25px','5px');
const highScoreDisplay2=makeLabel('High Score: '+highScore2,'25px','500px');
const timerDisplay=makeLabel('Time: 60','5px','50%');
timerDisplay.style.transform='translateX(-50%)';

const player2UI=[player2,scoreDisplay2,highScoreDisplay2];

/* ======================
   COINS
   ====================== */
let coins=[];
function spawnCoin(){
  const c=document.createElement('div');
  c.className='coin';
  c.style.left=Math.random()*(GAME_SIZE-COIN_SIZE)+'px';
  c.style.top=Math.random()*(GAME_SIZE-COIN_SIZE)+'px';
  gameArea.appendChild(c);
  coins.push(c);
}

/* ======================
   INPUT
   ====================== */
const keys={};
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && !menu.classList.contains('hidden')) return;

  if (e.key === 'Escape' && !gameOver) {
    isPaused = !isPaused;

    if (isPaused) {
      clearInterval(timerInterval);
    } else {
      startTimer();
    }
  }
});

/* ======================
   GAME LOOP
   ====================== */
function movePlayer(p,step,u,d,l,r){
  let x=parseInt(p.style.left)||0;
  let y=parseInt(p.style.top)||0;
  if(keys[u])y-=step;
  if(keys[d])y+=step;
  if(keys[l])x-=step;
  if(keys[r])x+=step;
  p.style.left=Math.max(0,Math.min(GAME_SIZE-PLAYER_SIZE,x))+'px';
  p.style.top=Math.max(0,Math.min(GAME_SIZE-PLAYER_SIZE,y))+'px';
}

function checkCollision(p,id){
  for(let i=coins.length-1;i>=0;i--){
    const c=coins[i];
    const px=parseInt(p.style.left), py=parseInt(p.style.top);
    const cx=parseInt(c.style.left), cy=parseInt(c.style.top);
    if(px<cx+COIN_SIZE && px+PLAYER_SIZE>cx &&
       py<cy+COIN_SIZE && py+PLAYER_SIZE>cy){
      gameArea.removeChild(c);
      coins.splice(i,1);
      spawnCoin();
      if(id===1){score1++; scoreDisplay1.textContent=`Score: ${score1}`;}
      else{score2++; scoreDisplay2.textContent=`Score: ${score2}`;}
    }
  }
}

function gameLoop(){
  if(!gameOver && !isPaused){
    movePlayer(player1,step1,'w','s','a','d');
    checkCollision(player1,1);
    if(gameMode===2){
      movePlayer(player2,step2,'ArrowUp','ArrowDown','ArrowLeft','ArrowRight');
      checkCollision(player2,2);
    }
  }
  rafId = requestAnimationFrame(gameLoop);
}

/* ======================
   TIMER
   ====================== */
if (timerInterval) clearInterval(timerInterval);
function startTimer(){
  timerInterval=setInterval(()=>{
    timeLeft--;
    timerDisplay.textContent=`Time: ${timeLeft}`;
    timerDisplay.textContent = isPaused ? 'Paused' : `Time: ${timeLeft}`;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      gameOver=true;
      endGame();
    }
  },1000);
}

function endGame(){
  highScore1 = Math.max(highScore1, score1);
  highScore2 = Math.max(highScore2, score2);
   
  highScoreDisplay1.textContent = 'High Score: ' + highScore1;
  highScoreDisplay2.textContent = 'High Score: ' + highScore2;
   
  finalScore1.textContent=`Player 1 Score: ${score1}`;
  finalHighScore1.textContent=`Player 1 High Score: ${Math.max(highScore1,score1)}`;
  if(gameMode===2){
    finalScore2.textContent=`Player 2 Score: ${score2}`;
    finalHighScore2.textContent=`Player 2 High Score: ${Math.max(highScore2,score2)}`;
    finalScore2.classList.remove('hidden');
    finalHighScore2.classList.remove('hidden');
  } else {
    finalScore2.classList.add('hidden');
    finalHighScore2.classList.add('hidden');
  }
  gameOverScreen.classList.remove('hidden');
}

/* ======================
   MENU CONTROL
   ====================== */
function updatePlayer2UI(){
  const single=gameMode===1;
  menuSpeed2.disabled=single;
  player2UI.forEach(el=>el.classList.toggle('hidden',single));
}

modeButtons.forEach(rb=>{
  rb.addEventListener('change',()=>{
    gameMode=Number(rb.value);
    updatePlayer2UI();
  });
});

startButton.onclick=()=>{
  resetGameState();
  step1=Number(menuSpeed1.value);
  step2=Number(menuSpeed2.value);
  menu.classList.add('hidden');
  saveButton.classList.remove('hidden');
  for(let i=0;i<10;i++)spawnCoin();
  startTimer();
  rafId = requestAnimationFrame(gameLoop);
};

saveButton.onclick = async () => {
  localStorage.setItem('highScore1', highScore1);
  localStorage.setItem('highScore2', highScore2);
  localStorage.setItem('player1Speed', step1);
  localStorage.setItem('player2Speed', step2);

  try{
    await fetch('https://script.google.com/macros/s/AKfycbwct-j94qIwoqet8fc3uss54WZ0uK2EsBpQSUkcb6N5nOtHofouSSsldnVZiaJ7XKlvOw/exec', {
      method: 'POST',
      body: JSON.stringify({
        p1: { high: highScore1, speed: step1 },
        p2: { high: highScore2, speed: step2 }
      })
    });
  }catch{}

  alert('Game Saved!');
};

/* ======================
   BACK TO MENU (NEW)
   ====================== */
function resetGameState(){
  gameOver = false;
  isPaused = false;
  timeLeft = 60;
  score1 = 0;
  score2 = 0;

  coins.forEach(c => c.remove());
  coins = [];

  timerDisplay.textContent = 'Time: 60';
  scoreDisplay1.textContent = 'Score: 0';
  scoreDisplay2.textContent = 'Score: 0';

  clearInterval(timerInterval);
  if (rafId) cancelAnimationFrame(rafId);
}

backToMenu.onclick=()=>{
  gameOverScreen.classList.add('hidden');
  menu.classList.remove('hidden');
  saveButton.classList.add('hidden');

   resetGameState();
};

gameOverReplay.onclick = () => {
  gameOverScreen.classList.add('hidden');
  resetGameState();

  for (let i = 0; i < 10; i++) spawnCoin();
  startTimer();
  rafId = requestAnimationFrame(gameLoop);
};

/* ======================
   STORAGE (LOAD)
   ====================== */
async function syncLoad(){
  try{
    const res=await fetch('https://script.google.com/macros/s/AKfycbwct-j94qIwoqet8fc3uss54WZ0uK2EsBpQSUkcb6N5nOtHofouSSsldnVZiaJ7XKlvOw/exec?action=getData');
    const data=await res.json();
    data.forEach(([p,h,s])=>{
      if(p==='Player1'){highScore1=h;step1=s;}
      if(p==='Player2'){highScore2=h;step2=s;}
    });
  }catch{}
  menuSpeed1.value=step1;
  menuSpeed2.value=step2;
}

/* ======================
   INIT
   ====================== */
(async()=>{
  menuSpeed1.disabled=true;
  menuSpeed2.disabled=true;
  await syncLoad();
  updatePlayer2UI();
  loadingScreen.classList.add('hidden');
  menu.classList.remove('hidden');
  menuSpeed1.disabled=false;
})();
</script>
</body>
</html>
 
